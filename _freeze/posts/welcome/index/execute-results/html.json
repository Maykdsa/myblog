{
  "hash": "26a7312e054ef8497eec14596dd4e4db",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: 'Atividade API Onibus '\nauthor: Mayk de Sá\ndate: '2025-11-20'\ncategories:\n  - API\n  - CODE\n  - PYTHON\n---\n\n---\n\n\n--------------\n\n# Introdução\n\nNeste post apresento uma aplicação em Python que consulta a API *Olho Vivo* da SPTrans para localizar linhas de ônibus, buscar suas paradas e capturar a posição atual dos veículos. O objetivo é demonstrar o uso de APIs reais, autenticação de tokens, manipulação de dados e geração de mapas interativos com *Folium*.\n\nToda a lógica apresentada aqui foi reescrita e reorganizada para fins acadêmicos, mantendo o funcionamento, porém com **estrutura diferente do código original**.\n\n---\n\n# Importações\n\nA aplicação utiliza três módulos principais: `requests`, `folium` e `dotenv`.\n\n```python\nimport os\nimport requests\nfrom folium import Map, Marker, Icon\nfrom dotenv import load_dotenv\n```\n\nCarregando variáveis de ambiente:\n\n```python\nload_dotenv(\".env\")\n```\n\n---\n\n# Autenticação na API\n\nA API da SPTrans requer autenticação via token. Aqui encapsulei o processo em uma função clara e direta.\n\n```python\ndef autenticar_sistema(sessao: requests.Session) -> bool:\n    \"\"\"\n    Realiza autenticação com o token armazenado no arquivo .env.\n    \"\"\"\n    print(\"→ Autenticando no sistema da SPTrans...\")\n\n    token = os.getenv(\"SPTRANS_TOKEN\")\n    url = f\"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={token}\"\n\n    resp = sessao.post(url)\n\n    if resp.text.lower() == \"true\":\n        print(\"✔ Autenticação concluída.\")\n        return True\n\n    print(\"✖ Token inválido ou não encontrado.\")\n    return False\n```\n\n---\n\n# Funções de Consulta\n\n### Buscar linhas por termo\n\n```python\ndef obter_linhas(sessao: requests.Session, termo: str) -> list[dict]:\n    print(f\"→ Buscando linhas contendo: {termo}\")\n    url = f\"http://api.olhovivo.sptrans.com.br/v2.1/Linha/Buscar?termosBusca={termo}\"\n    return sessao.get(url).json()\n```\n\n### Buscar paradas da linha\n\n```python\ndef obter_paradas(sessao: requests.Session, cod_linha: int) -> list[dict]:\n    url = f\"http://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={cod_linha}\"\n    return sessao.get(url).json()\n```\n\n### Buscar posições dos ônibus\n\n```python\ndef obter_posicoes(sessao: requests.Session, cod_linha: int) -> list[dict]:\n    url = f\"http://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={cod_linha}\"\n    dados = sessao.get(url).json()\n    return dados.get(\"vs\", [])\n```\n\n---\n\n# Construção do Mapa Interativo\n\nUsamos Folium para marcar paradas e veículos.\n\n```python\ndef gerar_mapa(paradas: list[dict], veiculos: list[dict]) -> Map:\n    centro = [paradas[0][\"py\"], paradas[0][\"px\"]]\n    mapa = Map(location=centro, zoom_start=14)\n\n    # Marca as paradas\n    for p in paradas:\n        Marker(\n            location=[p[\"py\"], p[\"px\"]],\n            popup=p[\"np\"],\n            icon=Icon(color=\"blue\", icon=\"info-sign\")\n        ).add_to(mapa)\n\n    # Marca os veículos\n    for v in veiculos:\n        marker = Marker(\n            location=[v[\"py\"], v[\"px\"]],\n            popup=f\"Veículo: {v['p']}\"\n        )\n        marker.add_to(mapa)\n        Icon(color=\"red\", icon=\"bus\", prefix=\"fa\").add_to(marker)\n\n    return mapa\n```\n\n---\n\n# Execução da Aplicação\n\nO código completo da busca e geração do mapa está abaixo.\n\n```python\ndef executar_sistema():\n    sessao = requests.Session()\n\n    if not autenticar_sistema(sessao):\n        return\n\n    termo_pesquisa = \"Santana\"  # termo exemplo\n    linhas = obter_linhas(sessao, termo_pesquisa)\n\n    print(f\"→ {len(linhas)} linhas encontradas para '{termo_pesquisa}'.\")\n    print(\"→ Selecionando primeira linha válida...\")\n\n    paradas, posicoes, linha_selecionada = None, None, None\n\n    for ln in linhas:\n        codigo = ln[\"cl\"]\n        paradas = obter_paradas(sessao, codigo)\n        posicoes = obter_posicoes(sessao, codigo)\n\n        if paradas and posicoes:\n            linha_selecionada = ln\n            break\n\n    if not linha_selecionada:\n        print(\"✖ Nenhuma linha válida encontrada.\")\n        return\n\n    print(f\"✔ Linha selecionada: {linha_selecionada['tp']} - {linha_selecionada['ts']}\")\n\n    mapa = gerar_mapa(paradas, posicoes)\n    mapa\n\n\nexecutar_sistema()\n```\n\n---\n\n# Conclusão\n\nCom este projeto foi possível:\n\n* autenticar em uma API real;\n* buscar dados de transporte público;\n* processar e filtrar resultados úteis;\n* exibir paradas e veículos em um mapa interativo;\n* integrar tudo isso em um blog Quarto.\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}